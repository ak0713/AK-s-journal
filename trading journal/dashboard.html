<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #f0f0f0;
      padding: 30px;
    }

    .container {
      max-width: 1100px;
      margin: auto;
    }

    h1 {
      text-align: center;
      color: #00e676;
      font-size: 36px;
      margin-bottom: 10px;
    }

    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0 30px;
      flex-wrap: wrap;
    }

    .nav-buttons .button {
      background: #00e676;
      color: #000;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background 0.3s;
    }

    .nav-buttons .button:hover {
      background: #00c853;
    }

    .card {
      background: rgba(30, 30, 30, 0.95);
      border-radius: 20px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 20px;
    }

    .stats-grid .card {
      text-align: center;
    }

    .label {
      font-weight: 600;
      color: #aaa;
    }

    .value {
      font-size: 24px;
      font-weight: bold;
      color: #00e676;
    }

    canvas {
      margin-top: 30px;
      background: #1e1e1e;
      padding: 10px;
      border-radius: 15px;
    }

    input {
      padding: 10px;
      width: 200px;
      margin-top: 10px;
      border-radius: 10px;
      border: none;
      background: #1e1e1e;
      color: #fff;
    }

    .config-button {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Trading Dashboard</h1>

    <!-- Navigation Buttons -->
    <div class="nav-buttons">
      <button class="button" onclick="exportToPDF()">ðŸ“„ Export PDF</button>
      <a href="journal.html" class="button">ðŸ“˜ View Trades</a>
      <a href="gallery.html" class="button">ðŸ“¸ View Gallery</a>
    </div>

    <div class="card">
      <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
        <div>
          <label class="label">Starting Capital (â‚¹)</label><br>
          <input type="number" id="capitalInput" placeholder="â‚¹" />
        </div>
        <div>
          <label class="label">Target Profit (â‚¹)</label><br>
          <input type="number" id="targetInput" placeholder="â‚¹" />
        </div>
        <button class="button config-button" onclick="saveConfig()">Set Targets</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="card"><div class="label">Total P&L</div><div class="value" id="totalPnL">â‚¹0</div></div>
      <div class="card"><div class="label">Total Return (%)</div><div class="value" id="totalReturn">0%</div></div>
      <div class="card"><div class="label">Target Remaining</div><div class="value" id="targetLeft">â‚¹0</div></div>
      <div class="card"><div class="label">Average Win</div><div class="value" id="avgWin">â‚¹0</div></div>
      <div class="card"><div class="label">Average Loss</div><div class="value" id="avgLoss">â‚¹0</div></div>
      <div class="card"><div class="label">Win Rate</div><div class="value" id="winRate">0%</div></div>
      <div class="card"><div class="label">Winning Streak</div><div class="value" id="winStreak">0</div></div>
      <div class="card"><div class="label">Losing Streak</div><div class="value" id="lossStreak">0</div></div>
    </div>

    <canvas id="capitalChart" height="100"></canvas>
    <canvas id="monthlyChart" height="100"></canvas>
    <canvas id="weeklyChart" height="100"></canvas>
    <canvas id="winLossChart" height="100"></canvas>
  </div>

  <script>
    let trades = JSON.parse(localStorage.getItem("swingTrades")) || [];
    let startingCapital = parseFloat(localStorage.getItem("startingCapital")) || 0;
    let targetProfit = parseFloat(localStorage.getItem("targetProfit")) || 20000;

    document.getElementById("capitalInput").value = startingCapital;
    document.getElementById("targetInput").value = targetProfit;

    function saveConfig() {
      startingCapital = parseFloat(document.getElementById("capitalInput").value);
      targetProfit = parseFloat(document.getElementById("targetInput").value);
      localStorage.setItem("startingCapital", startingCapital);
      localStorage.setItem("targetProfit", targetProfit);
      location.reload();
    }

    function analyzeTrades() {
      let closedTrades = trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
      let totalPnL = 0, wins = [], losses = [];
      let streak = 0, maxWinStreak = 0, maxLossStreak = 0, prevWin = null;
      let capitalSeries = [startingCapital], monthly = {}, weekly = {};

      closedTrades.forEach(t => {
        let pnl = (t.exitPrice - t.entryPrice) * t.quantity;
        totalPnL += pnl;

        let date = new Date(t.exitDate);
        let monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthly[monthKey] = (monthly[monthKey] || 0) + pnl;

        let weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay());
        let weekKey = `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-W${Math.floor(weekStart.getDate() / 7) + 1}`;
        weekly[weekKey] = (weekly[weekKey] || 0) + pnl;

        capitalSeries.push(capitalSeries[capitalSeries.length - 1] + pnl);

        let isWin = pnl > 0;
        if (isWin) {
          wins.push(pnl);
          streak = (prevWin === true) ? streak + 1 : 1;
          maxWinStreak = Math.max(maxWinStreak, streak);
        } else {
          losses.push(pnl);
          streak = (prevWin === false) ? streak + 1 : 1;
          maxLossStreak = Math.max(maxLossStreak, streak);
        }
        prevWin = isWin;
      });

      let winRate = (wins.length / closedTrades.length) * 100 || 0;
      let avgWin = wins.length ? wins.reduce((a,b)=>a+b)/wins.length : 0;
      let avgLoss = losses.length ? losses.reduce((a,b)=>a+b)/losses.length : 0;
      let totalReturn = (totalPnL / startingCapital) * 100 || 0;
      let remaining = Math.max(0, targetProfit - totalPnL);

      document.getElementById("totalPnL").innerText = `â‚¹${totalPnL.toFixed(2)}`;
      document.getElementById("totalReturn").innerText = `${totalReturn.toFixed(2)}%`;
      document.getElementById("targetLeft").innerText = `â‚¹${remaining.toFixed(2)}`;
      document.getElementById("avgWin").innerText = `â‚¹${avgWin.toFixed(2)}`;
      document.getElementById("avgLoss").innerText = `â‚¹${avgLoss.toFixed(2)}`;
      document.getElementById("winRate").innerText = `${winRate.toFixed(2)}%`;
      document.getElementById("winStreak").innerText = maxWinStreak;
      document.getElementById("lossStreak").innerText = maxLossStreak;

      renderCharts(capitalSeries, monthly, weekly, wins.length, losses.length);
    }

    function renderCharts(capitalData, monthlyData, weeklyData, winCount, lossCount) {
      new Chart(document.getElementById("capitalChart").getContext("2d"), {
        type: 'line',
        data: {
          labels: capitalData.map((_, i) => `T${i}`),
          datasets: [{
            label: 'Capital Over Time',
            data: capitalData,
            borderColor: '#00e676',
            fill: true,
            backgroundColor: 'rgba(0,230,118,0.1)'
          }]
        }
      });

      new Chart(document.getElementById("monthlyChart").getContext("2d"), {
        type: 'bar',
        data: {
          labels: Object.keys(monthlyData),
          datasets: [{
            label: 'Monthly P&L',
            data: Object.values(monthlyData),
            backgroundColor: Object.values(monthlyData).map(p => p >= 0 ? '#00e676' : '#ef5350')
          }]
        }
      });

      new Chart(document.getElementById("weeklyChart").getContext("2d"), {
        type: 'bar',
        data: {
          labels: Object.keys(weeklyData),
          datasets: [{
            label: 'Weekly P&L',
            data: Object.values(weeklyData),
            backgroundColor: Object.values(weeklyData).map(p => p >= 0 ? '#00e676' : '#ef5350')
          }]
        }
      });

      new Chart(document.getElementById("winLossChart").getContext("2d"), {
        type: 'pie',
        data: {
          labels: ['Wins', 'Losses'],
          datasets: [{
            data: [winCount, lossCount],
            backgroundColor: ['#00e676', '#ef5350']
          }]
        }
      });
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(18);
      pdf.text("Trading Dashboard Report", 105, 15, { align: "center" });

      const stats = [
        ["Total P&L", document.getElementById("totalPnL").innerText],
        ["Total Return", document.getElementById("totalReturn").innerText],
        ["Target Remaining", document.getElementById("targetLeft").innerText],
        ["Average Win", document.getElementById("avgWin").innerText],
        ["Average Loss", document.getElementById("avgLoss").innerText],
        ["Win Rate", document.getElementById("winRate").innerText],
        ["Winning Streak", document.getElementById("winStreak").innerText],
        ["Losing Streak", document.getElementById("lossStreak").innerText]
      ];

      pdf.setFontSize(12);
      stats.forEach((stat, index) => {
        pdf.text(`${stat[0]}: ${stat[1]}`, 20, 30 + index * 10);
      });

      const charts = [
        { id: 'capitalChart', title: 'Capital Over Time' },
        { id: 'monthlyChart', title: 'Monthly P&L' },
        { id: 'weeklyChart', title: 'Weekly P&L' },
        { id: 'winLossChart', title: 'Win/Loss Breakdown' }
      ];

      for (const chart of charts) {
        const canvas = document.getElementById(chart.id);
        const img = canvas.toDataURL("image/png", 1.0);
        pdf.addPage();
        pdf.setFontSize(14);
        pdf.text(chart.title, 105, 15, { align: "center" });
        pdf.addImage(img, 'PNG', 10, 25, 190, 100);
      }

      pdf.save("TradingDashboard_Report.pdf");
    }

    analyzeTrades();
  </script>
</body>
</html>
